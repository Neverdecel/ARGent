{% extends "base.html" %}

{% block title %}{{ thread_subject or title }} - ARGent{% endblock %}

{% block content %}
<div class="thread-page">
    <div class="thread-header">
        <a href="/inbox" class="back-btn">&larr;</a>
        <div class="thread-title-section">
            <h1>{{ thread_subject or title }}</h1>
            <span class="thread-count">{{ messages|length }} message{% if messages|length != 1 %}s{% endif %}</span>
        </div>
    </div>

    <div class="thread-messages" id="thread-messages">
        {% for msg in messages %}
        <div class="thread-email {% if msg.id == focused_message_id %}expanded{% else %}collapsed{% endif %}"
             data-message-id="{{ msg.id }}"
             data-sender="{{ msg.sender_name or 'Unknown' }}"
             data-date="{{ msg.created_at.strftime('%b %d, %Y at %I:%M %p') }}"
             data-content="{{ msg.content | e }}">

            <!-- Collapsed view (clickable header) -->
            <div class="email-collapsed-header" onclick="toggleEmail(this)">
                {% if msg.avatar_url %}
                <img src="{{ msg.avatar_url }}" alt="" class="email-avatar">
                {% else %}
                <div class="email-avatar-placeholder">{{ (msg.sender_name or 'U')[0] }}</div>
                {% endif %}
                <div class="email-summary">
                    <span class="email-sender">{{ msg.sender_name or 'Unknown' }}</span>
                    <span class="email-preview">{{ (msg.content or '')[:60] }}{% if (msg.content or '')|length > 60 %}...{% endif %}</span>
                </div>
                <span class="email-date">{{ msg.created_at.strftime('%b %d, %I:%M %p') }}</span>
                <span class="email-expand-icon">▼</span>
            </div>

            <!-- Expanded view (full email) -->
            <div class="email-expanded">
                <div class="email-header">
                    <div class="email-meta-row">
                        <span class="email-meta-label">From:</span>
                        <span class="email-meta-value">
                            {% if msg.avatar_url %}
                            <img src="{{ msg.avatar_url }}" alt="" class="email-header-avatar">
                            {% endif %}
                            {{ msg.sender_name or 'Unknown' }}
                        </span>
                    </div>
                    <div class="email-meta-row">
                        <span class="email-meta-label">To:</span>
                        <span class="email-meta-value">{% if msg.direction == 'outbound' %}You{% else %}{{ title }}{% endif %}</span>
                    </div>
                    <div class="email-meta-row">
                        <span class="email-meta-label">Date:</span>
                        <span class="email-meta-value">{{ msg.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                    </div>
                    {% if msg.subject %}
                    <div class="email-meta-row">
                        <span class="email-meta-label">Subject:</span>
                        <span class="email-meta-value email-subject-text">{{ msg.subject }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="email-body">
                    {% if msg.html_content %}
                    {{ msg.html_content | safe }}
                    {% else %}
                    {{ (msg.content or '') | replace('\n', '<br>') | safe }}
                    {% endif %}
                </div>
                {% if loop.first %}
                <div class="email-actions">
                    <button type="button" class="btn btn-secondary reply-btn" onclick="showReplyForm(this)">
                        Reply
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Typing indicator for email view -->
        <div class="typing-indicator" id="typing-indicator" style="margin-top: 8px;">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    </div>

    <!-- Reply form - hidden by default, shown when clicking Reply -->
    <div id="reply-section" class="reply-section" style="display: none;">
        <div class="compose-card">
            <div class="compose-header">
                <span class="compose-title">Reply</span>
                <button type="button" class="close-btn" onclick="hideReplyForm()">&times;</button>
            </div>
            <form id="reply-form" class="compose-form">
                <input type="hidden" name="session_id" value="{{ session_id }}">

                <!-- To field (read-only) -->
                <div class="compose-field">
                    <label class="compose-label">To:</label>
                    <span class="compose-value">{{ title }}</span>
                </div>

                <!-- From field (read-only) -->
                <div class="compose-field">
                    <label class="compose-label">From:</label>
                    <span class="compose-value">You</span>
                </div>

                <!-- Subject field (pre-filled with Re:) -->
                <div class="compose-field">
                    <label class="compose-label">Subject:</label>
                    <input type="text" id="reply-subject" name="subject"
                           value="{% if thread_subject %}Re: {{ thread_subject }}{% endif %}" class="compose-input"
                           placeholder="Subject (optional)">
                </div>

                <!-- Separator -->
                <div class="compose-separator"></div>

                <!-- Message body -->
                <div class="compose-body">
                    <textarea id="reply-content" name="content"
                              placeholder="Write your reply..." rows="6" required
                              autocomplete="off"></textarea>

                    <!-- Quoted message (collapsed by default) -->
                    <div class="quoted-message-container">
                        <button type="button" class="quote-toggle" onclick="toggleQuote()">
                            <span class="quote-icon">▶</span> Show quoted text
                        </button>
                        <div class="quoted-message" style="display: none;">
                            <div id="quote-header" class="quote-header"></div>
                            <div id="quote-content" class="quote-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="compose-actions">
                    <button type="submit" class="btn btn-primary">Send</button>
                    <button type="button" class="btn btn-secondary" onclick="hideReplyForm()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include "partials/bottom_nav.html" %}
{% endblock %}

{% block scripts %}
<script>
// Elements
const threadMessages = document.getElementById('thread-messages');
const typingIndicator = document.getElementById('typing-indicator');
let replyingToMessageId = null;

// Typing indicator controls
function showTypingIndicator() {
    typingIndicator.classList.add('visible');
    typingIndicator.scrollIntoView({ behavior: 'smooth', block: 'end' });
}

function hideTypingIndicator() {
    typingIndicator.classList.remove('visible');
}

function toggleEmail(header) {
    const email = header.closest('.thread-email');
    const wasExpanded = email.classList.contains('expanded');

    email.classList.toggle('expanded');
    email.classList.toggle('collapsed');

    // Update expand icon
    const icon = header.querySelector('.email-expand-icon');
    if (icon) {
        icon.textContent = wasExpanded ? '▼' : '▲';
    }
}

function showReplyForm(button) {
    const emailEl = button.closest('.thread-email');
    const sender = emailEl.dataset.sender;
    const date = emailEl.dataset.date;
    const content = emailEl.dataset.content;

    replyingToMessageId = emailEl.dataset.messageId;

    // Clear the textarea (in case browser restored form data)
    document.getElementById('reply-content').value = '';

    // Update quoted text
    document.getElementById('quote-header').textContent = `On ${date}, ${sender} wrote:`;
    document.getElementById('quote-content').textContent = content;

    // Show reply section
    const replySection = document.getElementById('reply-section');
    replySection.style.display = 'block';

    // Move reply section after the clicked message
    emailEl.after(replySection);

    // Focus the textarea
    document.getElementById('reply-content').focus();

    // Scroll to reply form
    replySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function hideReplyForm() {
    const replySection = document.getElementById('reply-section');
    replySection.style.display = 'none';
    document.getElementById('reply-content').value = '';

    // Reset quoted text visibility
    const quote = document.querySelector('.quoted-message');
    if (quote) quote.style.display = 'none';
    const toggle = document.querySelector('.quote-toggle');
    if (toggle) toggle.innerHTML = '<span class="quote-icon">▶</span> Show quoted text';

    replyingToMessageId = null;
}

function toggleQuote() {
    const container = document.querySelector('.quoted-message-container');
    if (!container) return;

    const quote = container.querySelector('.quoted-message');
    const icon = container.querySelector('.quote-icon');
    const toggle = container.querySelector('.quote-toggle');
    if (!quote) return;

    if (quote.style.display === 'none') {
        quote.style.display = 'block';
        if (icon) icon.classList.add('expanded');
        if (toggle) toggle.innerHTML = '<span class="quote-icon expanded">▶</span> Hide quoted text';
    } else {
        quote.style.display = 'none';
        if (icon) icon.classList.remove('expanded');
        if (toggle) toggle.innerHTML = '<span class="quote-icon">▶</span> Show quoted text';
    }
}

// Form submission handler
document.getElementById('reply-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const content = document.getElementById('reply-content').value;
    const subject = document.getElementById('reply-subject').value.trim();
    const sessionId = form.querySelector('input[name="session_id"]').value;
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const requestBody = {
        content: content,
        session_id: sessionId
    };

    if (subject) {
        requestBody.subject = subject;
    }

    try {
        const response = await fetch('/api/inbox/compose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (response.ok) {
            // Hide reply form
            hideReplyForm();
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send';

            // Show typing indicator while waiting for response
            setTimeout(() => {
                showTypingIndicator();
            }, 300);

            // Start fast polling - will pick up both sent message and agent response
            startFastPolling();
        } else {
            const error = await response.json();
            alert('Failed to send: ' + (error.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send';
        }
    } catch (err) {
        alert('Failed to send message. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send';
    }
});

// Polling for new messages
let pollInterval = null;
let fastPollCount = 0;

// Track existing message IDs (messages are displayed newest-first)
function getExistingMessageIds() {
    const ids = new Set();
    document.querySelectorAll('.thread-email').forEach(el => {
        const id = el.dataset.messageId;
        if (id) ids.add(id);
    });
    return ids;
}

function startFastPolling() {
    fastPollCount = 15;
    if (pollInterval) {
        clearInterval(pollInterval);
    }
    pollInterval = setInterval(checkForNewMessages, 2000);
}

function checkForNewMessages() {
    // Don't refresh if user is composing a reply
    if (document.getElementById('reply-section').style.display !== 'none') {
        return;
    }

    const existingIds = getExistingMessageIds();
    const existingCount = existingIds.size;
    const url = window.location.href + (window.location.href.includes('?') ? '&' : '?') + '_t=' + Date.now();
    fetch(url, {
        headers: { 'Accept': 'text/html' },
        cache: 'no-store'
    })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newThreadMessages = doc.getElementById('thread-messages');
            const newEmails = doc.querySelectorAll('.thread-email');

            // Check if there are new messages by comparing IDs
            let hasNewMessages = false;
            newEmails.forEach(email => {
                const id = email.dataset.messageId;
                if (id && !existingIds.has(id)) {
                    hasNewMessages = true;
                }
            });

            if (hasNewMessages) {
                // Hide typing indicator and reload the page to show new messages
                // This ensures correct rendering without duplication issues
                hideTypingIndicator();
                window.location.reload();
                return;
            }

            // Slow down polling after fast period
            if (fastPollCount > 0) {
                fastPollCount--;
            } else if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = setInterval(checkForNewMessages, 10000);
            }
        })
        .catch(() => {
            // Ignore errors, keep polling
        });
}

// Start slow background polling
pollInterval = setInterval(checkForNewMessages, 10000);

// Initialize expand icons
document.querySelectorAll('.thread-email').forEach(email => {
    const icon = email.querySelector('.email-expand-icon');
    if (icon) {
        icon.textContent = email.classList.contains('expanded') ? '▲' : '▼';
    }
});
</script>
{% endblock %}
