{% extends "base.html" %}

{% block title %}Compose - ARGent{% endblock %}

{% block content %}
<div class="compose-page">
    <div class="compose-header">
        <a href="/inbox" class="back-btn">&larr;</a>
        <h1>New Message</h1>
    </div>

    <form id="compose-form" class="form">
        {% if reply_to_session %}
        <input type="hidden" name="session_id" value="{{ reply_to_session }}">
        {% endif %}

        <div class="form-group">
            <label for="recipient">To</label>
            <select id="recipient" name="recipient" required>
                <option value="ember">Ember (via Email)</option>
                <option value="miro">Miro (via SMS)</option>
            </select>
            <span class="help-text">Choose who you want to message</span>
        </div>

        <div class="form-group" id="subject-group">
            <label for="subject">Subject</label>
            <input type="text" id="subject" name="subject" placeholder="Enter subject...">
            <span class="help-text">Optional subject line for email messages</span>
        </div>

        <div class="form-group">
            <label for="content">Message</label>
            <textarea
                id="content"
                name="content"
                placeholder="Type your message..."
                rows="8"
                required
            ></textarea>
        </div>

        <div class="form-actions">
            <a href="/inbox" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Send Message</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show/hide subject field based on recipient
document.getElementById('recipient').addEventListener('change', function(e) {
    const subjectGroup = document.getElementById('subject-group');
    if (e.target.value === 'miro') {
        subjectGroup.style.display = 'none';
    } else {
        subjectGroup.style.display = 'block';
    }
});

document.getElementById('compose-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const content = document.getElementById('content').value;
    const subject = document.getElementById('subject').value;
    const sessionId = form.querySelector('input[name="session_id"]')?.value;
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    try {
        const response = await fetch('/api/inbox/compose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: content,
                subject: subject || null,
                session_id: sessionId || null
            })
        });

        if (response.ok) {
            // Redirect to inbox
            window.location.href = '/inbox';
        } else {
            const error = await response.json();
            alert('Failed to send: ' + (error.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Message';
        }
    } catch (err) {
        alert('Failed to send message. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Message';
    }
});
</script>
{% endblock %}
