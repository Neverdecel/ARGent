{% extends "base.html" %}

{% block title %}Login - ARGent{% endblock %}

{% block content %}
<div class="login">
    <h1>Welcome Back</h1>

    <!-- Email Entry State -->
    <div id="email-state">
        <p class="subtitle">Continue your journey</p>

        <form id="login-form" class="form">
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" required
                       placeholder="your@email.com"
                       autocomplete="email"
                       {% if prefill_email %}value="{{ prefill_email }}"{% endif %}>
            </div>

            <button type="submit" class="btn btn-primary">Continue</button>

            <div id="form-error" class="alert alert-error" style="display: none;"></div>
        </form>

        <p class="back-link">New here? <a href="/register">Register</a></p>
    </div>

    <!-- Check Email State -->
    <div id="check-email-state" style="display: none;">
        <p class="subtitle">Check your email</p>

        <div class="check-email-message">
            <p>We sent a login link to <strong id="sent-email"></strong></p>
            <p class="hint">The link expires in 15 minutes.</p>
        </div>

        <div id="resend-section">
            <p class="resend-text">Didn't receive it?</p>
            <button id="resend-btn" class="btn btn-secondary" disabled>
                Resend in <span id="countdown">60</span>s
            </button>
        </div>

        <div id="resend-success" class="alert alert-success" style="display: none;">
            New link sent!
        </div>

        <p class="back-link">
            <a href="#" id="use-different-email">Use a different email</a>
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const emailState = document.getElementById('email-state');
    const checkEmailState = document.getElementById('check-email-state');
    const loginForm = document.getElementById('login-form');
    const errorDiv = document.getElementById('form-error');
    const sentEmailSpan = document.getElementById('sent-email');
    const resendBtn = document.getElementById('resend-btn');
    const countdownSpan = document.getElementById('countdown');
    const resendSuccess = document.getElementById('resend-success');
    const useDifferentEmail = document.getElementById('use-different-email');

    let countdownInterval = null;
    let currentEmail = '';

    // Check for error query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    if (error === 'invalid_magic_link') {
        errorDiv.textContent = 'This login link is invalid or has expired. Please request a new one.';
        errorDiv.style.display = 'block';
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    function showEmailState() {
        emailState.style.display = 'block';
        checkEmailState.style.display = 'none';
        clearInterval(countdownInterval);
    }

    function showCheckEmailState(email) {
        emailState.style.display = 'none';
        checkEmailState.style.display = 'block';
        sentEmailSpan.textContent = email;
        currentEmail = email;
        startCountdown();
    }

    function startCountdown() {
        let seconds = 60;
        resendBtn.disabled = true;
        resendBtn.innerHTML = 'Resend in <span id="countdown">' + seconds + '</span>s';
        resendSuccess.style.display = 'none';

        clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
            seconds--;
            const span = document.getElementById('countdown');
            if (span) span.textContent = seconds;

            if (seconds <= 0) {
                clearInterval(countdownInterval);
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend link';
            }
        }, 1000);
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = loginForm.querySelector('button[type="submit"]');
        errorDiv.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Sending...';

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: loginForm.email.value }),
            });

            const data = await response.json();

            if (response.ok) {
                showCheckEmailState(loginForm.email.value);
            } else {
                let errorMessage = 'Login failed';
                if (typeof data.detail === 'string') {
                    errorMessage = data.detail;
                } else if (Array.isArray(data.detail)) {
                    errorMessage = data.detail.map(err => err.msg || err.message || String(err)).join(', ');
                }
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
            }
        } catch (err) {
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Continue';
        }
    });

    resendBtn.addEventListener('click', async () => {
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending...';
        resendSuccess.style.display = 'none';

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: currentEmail }),
            });

            if (response.ok) {
                resendSuccess.style.display = 'block';
                startCountdown();
            } else {
                const data = await response.json();
                if (response.status === 429) {
                    // Rate limited - extract seconds and restart countdown
                    const match = data.detail.match(/(\d+) seconds/);
                    if (match) {
                        let seconds = parseInt(match[1]);
                        resendBtn.innerHTML = 'Resend in <span id="countdown">' + seconds + '</span>s';
                        clearInterval(countdownInterval);
                        countdownInterval = setInterval(() => {
                            seconds--;
                            const span = document.getElementById('countdown');
                            if (span) span.textContent = seconds;
                            if (seconds <= 0) {
                                clearInterval(countdownInterval);
                                resendBtn.disabled = false;
                                resendBtn.textContent = 'Resend link';
                            }
                        }, 1000);
                    }
                } else {
                    resendBtn.textContent = 'Resend link';
                    resendBtn.disabled = false;
                }
            }
        } catch (err) {
            resendBtn.textContent = 'Resend link';
            resendBtn.disabled = false;
        }
    });

    useDifferentEmail.addEventListener('click', (e) => {
        e.preventDefault();
        showEmailState();
        loginForm.email.value = '';
        loginForm.email.focus();
    });
})();
</script>
{% endblock %}
