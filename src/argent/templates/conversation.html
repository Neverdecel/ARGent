{% extends "base.html" %}

{% block title %}{{ title }} - ARGent{% endblock %}

{% block content %}
<div class="conversation-page">
    <div class="conversation-header">
        <a href="/inbox" class="back-btn">&larr;</a>
        <h1>{{ title }}</h1>
    </div>

    <div class="message-thread">
        {% for msg in messages %}
        <div class="message {% if msg.direction == 'inbound' %}message-sent{% else %}message-received{% endif %}">
            {% if msg.subject %}
            <!-- Email-client style header -->
            <div class="email-header">
                <div class="email-meta-row">
                    <span class="email-meta-label">From:</span>
                    <span class="email-meta-value">
                        {% if msg.direction == 'outbound' and msg.avatar_url %}
                        <img src="{{ msg.avatar_url }}" alt="" class="email-header-avatar">
                        {% endif %}
                        {{ msg.sender_name or 'Unknown' }}
                    </span>
                </div>
                <div class="email-meta-row">
                    <span class="email-meta-label">Subject:</span>
                    <span class="email-meta-value email-subject-text">{{ msg.subject }}</span>
                </div>
                <div class="email-meta-row">
                    <span class="email-meta-label">Date:</span>
                    <span class="email-meta-value">{{ msg.created_at.strftime('%b %d, %Y at %I:%M %p') }}</span>
                </div>
            </div>
            <div class="email-separator"></div>
            {% else %}
            <!-- Simple header (no subject) -->
            <div class="message-header">
                {% if msg.direction == 'outbound' and msg.avatar_url %}
                <img src="{{ msg.avatar_url }}" alt="{{ msg.sender_name }}" class="message-avatar">
                {% endif %}
                <div class="message-sender">{{ msg.sender_name or 'Unknown' }}</div>
            </div>
            {% endif %}

            <div class="message-content">
                {% if msg.html_content %}
                {{ msg.html_content | safe }}
                {% else %}
                {{ msg.content | default('', true) | replace('\n', '<br>') | safe }}
                {% endif %}
            </div>

            {% if not msg.subject %}
            <div class="message-time">{{ msg.created_at.strftime('%b %d, %I:%M %p') }}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <div class="reply-section">
        <form id="reply-form" class="reply-form">
            <input type="hidden" name="session_id" value="{{ session_id }}">

            <!-- Subject toggle and field -->
            <div class="subject-toggle-row">
                <a href="#" id="toggle-subject" class="toggle-subject-link">+ Add subject</a>
            </div>
            <div class="form-group subject-field-group" style="display: none;">
                <input type="text" id="reply-subject" name="subject"
                       placeholder="Subject (optional)" maxlength="100">
            </div>

            <div class="form-group">
                <textarea
                    id="reply-content"
                    name="content"
                    placeholder="Type your reply..."
                    rows="3"
                    required
                ></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send Reply</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Subject toggle handler
document.getElementById('toggle-subject').addEventListener('click', function(e) {
    e.preventDefault();
    const subjectGroup = document.querySelector('.subject-field-group');
    const link = e.target;

    if (subjectGroup.style.display === 'none') {
        subjectGroup.style.display = 'block';
        link.textContent = 'âˆ’ Remove subject';
        document.getElementById('reply-subject').focus();
    } else {
        subjectGroup.style.display = 'none';
        link.textContent = '+ Add subject';
        document.getElementById('reply-subject').value = '';
    }
});

// Form submission handler
document.getElementById('reply-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const content = document.getElementById('reply-content').value;
    const subject = document.getElementById('reply-subject').value.trim();
    const sessionId = form.querySelector('input[name="session_id"]').value;
    const submitBtn = form.querySelector('button[type="submit"]');

    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';

    const requestBody = {
        content: content,
        session_id: sessionId
    };

    if (subject) {
        requestBody.subject = subject;
    }

    try {
        const response = await fetch('/api/inbox/compose', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });

        if (response.ok) {
            // Reload page to show new message
            window.location.reload();
        } else {
            const error = await response.json();
            alert('Failed to send: ' + (error.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Reply';
        }
    } catch (err) {
        alert('Failed to send message. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Reply';
    }
});
</script>
{% endblock %}
